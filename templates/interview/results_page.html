{% extends 'base.html' %}

{% block title %}Interview Results{% endblock %}
{% block page_title %}Interview Results{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-11 mx-auto">
        <!-- Hero Score Card -->
        <div class="card mb-4" style="padding:28px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);">
            <div class="row align-items-center g-4">
                <div class="col-md-8">
                    <h2 style="margin:0 0 8px 0; font-size:28px; font-weight:700;">Interview Complete!</h2>
                    <div style="color:var(--text-muted); font-size:14px; margin-bottom:16px;">
                        {{ score_details.total_questions }} questions • {{ session.current_level|default:"Beginner"|title }} level
                    </div>
                    
                    {% if session.recommended_next_level and session.recommended_next_level != session.current_level %}
                    <div class="alert alert-success" style="margin:0; padding:12px 16px;">
                        <i class="bi bi-trophy-fill"></i> <strong>Excellent Performance!</strong> You're ready to advance: <strong>{{ session.current_level|title }} → {{ session.recommended_next_level|title }}</strong>
                        <div style="font-size:12px; margin-top:6px; opacity:0.9;">Your strong grasp of {{ session.current_level }} concepts qualifies you for the next challenge level.</div>
                    </div>
                    {% elif session.evaluation_flag == 'Easier' %}
                    <div class="alert alert-warning" style="margin:0; padding:12px 16px;">
                        <i class="bi bi-exclamation-triangle-fill"></i> <strong>Focus on Fundamentals</strong>
                        <div style="font-size:12px; margin-top:6px;">
                            {% if score_details.percentage >= 70 %}
                            Your score is good, but review the missed concepts below to strengthen your foundation before advancing.
                            {% elif score_details.percentage >= 60 %}
                            Practice the weak areas identified below. Consider reviewing course materials or documentation for the key concepts you missed.
                            {% else %}
                            Take time to revisit core concepts. Study the key topics below, practice with similar questions, and retake when ready.
                            {% endif %}
                        </div>
                    </div>
                    {% elif score_details.percentage >= 85 %}
                    <div class="alert alert-success" style="margin:0; padding:12px 16px;">
                        <i class="bi bi-check-circle-fill"></i> <strong>Outstanding Work!</strong>
                        <div style="font-size:12px; margin-top:6px;">You've demonstrated excellent mastery of {{ session.current_level }} concepts. Keep this momentum going!</div>
                    </div>
                    {% elif score_details.percentage >= 75 %}
                    <div class="alert alert-info" style="margin:0; padding:12px 16px;">
                        <i class="bi bi-star-fill"></i> <strong>Great Job!</strong>
                        <div style="font-size:12px; margin-top:6px;">Solid performance! Review the areas below where you can improve to reach excellence.</div>
                    </div>
                    {% elif score_details.percentage >= 60 %}
                    <div class="alert alert-info" style="margin:0; padding:12px 16px;">
                        <i class="bi bi-lightbulb-fill"></i> <strong>Good Effort!</strong>
                        <div style="font-size:12px; margin-top:6px;">You're on the right track. Focus on the mid-scoring questions below to boost your understanding.</div>
                    </div>
                    {% else %}
                    <div class="alert alert-warning" style="margin:0; padding:12px 16px;">
                        <i class="bi bi-bookmark-fill"></i> <strong>Keep Learning!</strong>
                        <div style="font-size:12px; margin-top:6px;">Don't be discouraged! Review the concepts carefully, practice regularly, and you'll see improvement soon.</div>
                    </div>
                    {% endif %}
                </div>
                
                <div class="col-md-4 text-center">
                    <div class="progress-circle" style="--progress: {{ score_details.percentage }}%; background: conic-gradient(var(--primary-color) 0% {{ score_details.percentage }}%, #e9ecef {{ score_details.percentage }}% 100%); width:140px; height:140px; margin:0 auto;">
                        <div class="progress-text" style="background:#fff; font-size:32px; font-weight:700;">{{ score_details.percentage }}%</div>
                    </div>
                    <div style="margin-top:12px; font-size:18px; font-weight:600;">Grade {{ score_details.grade }}</div>
                    <div style="color:var(--text-muted); font-size:13px;">{{ score_details.feedback }}</div>
                </div>
            </div>

            {% if marks %}
            <hr style="margin:20px 0;">
            <div class="row g-3">
                <div class="col-md-4">
                    <div style="text-align:center; padding:16px; background:#fff; border-radius:8px;">
                        <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px;">Marks Earned</div>
                        <div style="font-size:24px; font-weight:700;">{{ marks.total_marks_earned }}<span style="font-size:16px; color:var(--text-muted);">/{{ marks.total_marks_possible }}</span></div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div style="text-align:center; padding:16px; background:#fff; border-radius:8px;">
                        <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px;">Performance Level</div>
                        <div style="font-size:24px; font-weight:700;">{{ marks.performance_level }}</div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div style="text-align:center; padding:16px; background:#fff; border-radius:8px;">
                        <div style="font-size:12px; color:var(--text-muted); margin-bottom:4px;">Mark-Based Score</div>
                        <div style="font-size:24px; font-weight:700;">{{ marks.final_percentage }}%</div>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Analytics Dashboard -->
        <div class="row g-3 mb-4">
            <!-- Quick Stats -->
            <div class="col-md-6">
                <div class="card" style="padding:20px; height:100%;">
                    <h4 style="font-size:18px; font-weight:600; margin:0 0 16px 0;">Quick Stats</h4>
                    <div class="row g-3">
                        <div class="col-6">
                            <div style="text-align:center; padding:12px; background:var(--bg-light); border-radius:8px;">
                                <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Avg Score</div>
                                <div style="font-size:28px; font-weight:700; color:var(--primary-color); margin-top:4px;">{{ analytics.avg_pct }}%</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div style="text-align:center; padding:12px; background:var(--bg-light); border-radius:8px;">
                                <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Strong</div>
                                <div style="font-size:28px; font-weight:700; color:#22c55e; margin-top:4px;">{{ analytics.strong }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div style="text-align:center; padding:12px; background:var(--bg-light); border-radius:8px;">
                                <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Mid</div>
                                <div style="font-size:28px; font-weight:700; color:#f59e0b; margin-top:4px;">{{ analytics.mid }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div style="text-align:center; padding:12px; background:var(--bg-light); border-radius:8px;">
                                <div style="font-size:11px; color:var(--text-muted); text-transform:uppercase; letter-spacing:0.5px;">Weak</div>
                                <div style="font-size:28px; font-weight:700; color:#ef4444; margin-top:4px;">{{ analytics.weak }}</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Score Breakdown -->
            <div class="col-md-6">
                <div class="card" style="padding:20px; height:100%;">
                    <h4 style="font-size:18px; font-weight:600; margin:0 0 16px 0;">Smart Scoring</h4>
                    <p style="font-size:13px; color:#6b7280; margin-bottom:20px;">
                        Optimized algorithm rewarding comprehensive answers with coverage bonuses and lenient scoring.
                    </p>
                    {% with bd=analytics.breakdown_overall %}
                    <div style="background:#f9fafb; padding:16px; border-radius:8px; margin-bottom:12px;">
                        <div style="font-size:24px; font-weight:700; color:#6366f1; text-align:center;">
                            {{ analytics.avg_pct|default:0 }}%
                        </div>
                        <div style="font-size:12px; color:#6b7280; text-align:center;">Overall Score</div>
                    </div>
                    <div style="font-size:12px; color:#6b7280;">
                        <div style="margin-bottom:6px;">
                            <strong>Keyword Coverage (60%):</strong> Keywords + 10% bonus for 80%+ coverage
                        </div>
                        <div style="margin-bottom:6px;">
                            <strong>Technical Quality (20%):</strong> Depth and substantive terminology
                        </div>
                        <div>
                            <strong>Answer Detail (20%):</strong> Flexible length acceptance
                        </div>
                    </div>
                    {% endwith %}
                </div>
            </div>
        </div>

        <!-- Distribution & Keywords -->
        <div class="card mb-4" style="padding:20px;">
            <h4 style="font-size:18px; font-weight:600; margin:0 0 16px 0;">Performance Distribution</h4>
            
            {% if score_details.total_questions %}
                {% widthratio analytics.strong score_details.total_questions 100 as strong_pct %}
                {% widthratio analytics.mid score_details.total_questions 100 as mid_pct %}
                {% widthratio analytics.weak score_details.total_questions 100 as weak_pct %}
                <div style="margin-bottom:20px;">
                    <div class="progress" style="height:24px; border-radius:12px;">
                        <div class="progress-bar" style="width: {{ strong_pct }}%; background:#22c55e; font-size:13px; font-weight:600;" title="Strong {{ strong_pct }}%">
                            {% if strong_pct > 15 %}{{ strong_pct }}%{% endif %}
                        </div>
                        <div class="progress-bar" style="width: {{ mid_pct }}%; background:#f59e0b; font-size:13px; font-weight:600;" title="Mid {{ mid_pct }}%">
                            {% if mid_pct > 15 %}{{ mid_pct }}%{% endif %}
                        </div>
                        <div class="progress-bar" style="width: {{ weak_pct }}%; background:#ef4444; font-size:13px; font-weight:600;" title="Weak {{ weak_pct }}%">
                            {% if weak_pct > 15 %}{{ weak_pct }}%{% endif %}
                        </div>
                    </div>
                    <div class="d-flex justify-content-between" style="margin-top:8px; font-size:12px; color:var(--text-muted);">
                        <span><i class="bi bi-circle-fill" style="color:#22c55e; font-size:8px;"></i> Strong (≥75%): {{ analytics.strong }}</span>
                        <span><i class="bi bi-circle-fill" style="color:#f59e0b; font-size:8px;"></i> Mid (40-74%): {{ analytics.mid }}</span>
                        <span><i class="bi bi-circle-fill" style="color:#ef4444; font-size:8px;"></i> Weak (<40%): {{ analytics.weak }}</span>
                    </div>
                </div>
            {% endif %}

            <div class="row g-3">
                <div class="col-md-6">
                    <div style="padding:14px; background:rgba(34,197,94,0.05); border:1px solid rgba(34,197,94,0.2); border-radius:8px;">
                        <div style="font-size:13px; font-weight:600; margin-bottom:8px; color:#15803d;">
                            <i class="bi bi-check-circle"></i> Strengths
                        </div>
                        {% if analytics.top_categories %}
                            <div>
                                {% for category in analytics.top_categories %}
                                    <span class="badge" style="background:#22c55e; margin-right:6px; margin-bottom:6px;">{{ category }}</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div style="font-size:12px; color:var(--text-muted);">Complete more interviews to identify strengths</div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-6">
                    <div style="padding:14px; background:rgba(239,68,68,0.05); border:1px solid rgba(239,68,68,0.2); border-radius:8px;">
                        <div style="font-size:13px; font-weight:600; margin-bottom:8px; color:#b91c1c;">
                            <i class="bi bi-exclamation-circle"></i> Focus Areas
                        </div>
                        {% if analytics.weak_categories %}
                            <div>
                                {% for category in analytics.weak_categories %}
                                    <span class="badge" style="background:#ef4444; margin-right:6px; margin-bottom:6px;">{{ category }}</span>
                                {% endfor %}
                            </div>
                        {% else %}
                            <div style="font-size:12px; color:var(--text-muted);">Great job! No weak areas identified</div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Answer Details (Collapsible) -->
        <div class="card" style="padding:20px;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px;">
                <h4 style="font-size:18px; font-weight:600; margin:0;">Answer Details</h4>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleAllAnswers()" id="toggleBtn">
                    <i class="bi bi-chevron-down"></i> Expand All
                </button>
            </div>

            {% for question_text, answer_data in answers.items %}
                {% widthratio answer_data.score 1 100 as pct %}
                <div class="answer-item" style="border-top:1px solid var(--border-color); padding:16px 0;">
                    <div class="answer-header" style="cursor:pointer;" onclick="toggleAnswer(this)">
                        <div style="display:flex; justify-content:space-between; align-items:start; gap:12px;">
                            <div style="flex:1;">
                                <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px;">
                                    <i class="bi bi-chevron-right toggle-icon" style="transition:transform 0.2s; color:var(--text-muted);"></i>
                                    <h5 style="margin:0; font-size:16px; font-weight:600;">{{ question_text }}</h5>
                                </div>
                                {% if answer_data.keywords %}
                                <div style="margin-left:24px; font-size:12px; color:var(--text-muted);">
                                    {% for kw in answer_data.keywords|slice:":3" %}
                                        <span>{{ kw }}</span>{% if not forloop.last %}, {% endif %}
                                    {% endfor %}
                                    {% if answer_data.keywords|length > 3 %}...{% endif %}
                                </div>
                                {% endif %}
                            </div>
                            <div style="text-align:right;">
                                <span class="badge {% if answer_data.score >= 0.7 %}bg-success{% elif answer_data.score >= 0.4 %}bg-warning text-dark{% else %}bg-danger{% endif %}" style="font-size:14px; padding:6px 12px;">{{ pct }}%</span>
                            </div>
                        </div>
                    </div>

                    <div class="answer-content" style="display:none; margin-top:12px; margin-left:24px; padding:12px; background:var(--bg-light); border-radius:8px;">
                        <div style="margin-bottom:12px;">
                            <div style="font-size:12px; font-weight:600; color:var(--text-muted); margin-bottom:4px;">YOUR ANSWER</div>
                            <div style="font-size:14px; line-height:1.6;">
                                {{ answer_data.answer|default:"No answer provided" }}
                                {% if answer_data.echo_answer %}
                                <div class="alert alert-warning" style="font-size:12px; padding:8px 12px; margin-top:8px;">
                                    <i class="bi bi-info-circle"></i> Tip: Avoid repeating the question; provide your own detailed answer.
                                </div>
                                {% endif %}
                            </div>
                        </div>



                        {% if answer_data.keywords %}
                        <div style="margin-top:12px; padding-top:12px; border-top:1px solid var(--border-color);">
                            <div style="font-size:12px; font-weight:600; color:var(--text-muted); margin-bottom:6px;">KEY CONCEPTS</div>
                            <div>
                                {% for kw in answer_data.keywords %}
                                    <span class="badge bg-secondary" style="margin-right:4px; margin-bottom:4px; font-weight:500;">{{ kw }}</span>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            {% endfor %}

            <div style="text-align:center; margin-top:24px; padding-top:24px; border-top:1px solid var(--border-color);">
                <a href="{% url 'interview_dashboard' %}" class="btn btn-outline-primary me-2">
                    <i class="bi bi-house"></i> Back to Dashboard
                </a>
                <a href="{% url 'start_interview' %}" class="btn btn-primary">
                    <i class="bi bi-arrow-repeat"></i> Take Another Interview
                </a>
            </div>
        </div>
    </div>
</div>

<script>
function toggleAnswer(header) {
    const content = header.nextElementSibling;
    const icon = header.querySelector('.toggle-icon');
    if (content.style.display === 'none' || !content.style.display) {
        content.style.display = 'block';
        icon.style.transform = 'rotate(90deg)';
    } else {
        content.style.display = 'none';
        icon.style.transform = 'rotate(0deg)';
    }
}

function toggleAllAnswers() {
    const contents = document.querySelectorAll('.answer-content');
    const icons = document.querySelectorAll('.toggle-icon');
    const btn = document.getElementById('toggleBtn');
    const allExpanded = Array.from(contents).every(c => c.style.display === 'block');
    
    contents.forEach((content, idx) => {
        content.style.display = allExpanded ? 'none' : 'block';
        icons[idx].style.transform = allExpanded ? 'rotate(0deg)' : 'rotate(90deg)';
    });
    
    btn.innerHTML = allExpanded 
        ? '<i class="bi bi-chevron-down"></i> Expand All' 
        : '<i class="bi bi-chevron-up"></i> Collapse All';
}
</script>
{% endblock %}